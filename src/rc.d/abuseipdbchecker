#!/bin/sh
#
# PROVIDE: abuseipdbchecker
# REQUIRE: NETWORKING syslogd
# KEYWORD: shutdown
#

. /etc/rc.subr

name="abuseipdbchecker"
rcvar="abuseipdbchecker_enable"

load_rc_config $name

: ${abuseipdbchecker_enable="NO"}
abuseipdbchecker_cron="/usr/local/etc/cron.d/abuseipdbchecker"
pidfile="/var/run/${name}.pid"

command="/usr/local/opnsense/scripts/AbuseIPDBChecker/checker.py"
start_cmd="${name}_start"
stop_cmd="${name}_stop"
status_cmd="${name}_status"

abuseipdbchecker_start()
{    
    # Ensure config exists using OPNsense template system
    if [ ! -f /usr/local/etc/abuseipdb_checker.conf ]; then
        echo "Generating initial configuration file"
        /usr/local/sbin/configctl template reload OPNsense/AbuseIPDBChecker
    fi
    
    # Ensure the script exists and is executable
    if [ ! -x /usr/local/opnsense/scripts/AbuseIPDBChecker/checker.py ]; then
        echo "Error: Checker script not found or not executable"
        return 1
    fi
    
    # Generate cron job
    echo "# DO NOT EDIT THIS FILE - Generated by rc.d/${name}" > ${abuseipdbchecker_cron}
    echo "0 * * * * root /usr/local/opnsense/scripts/AbuseIPDBChecker/checker.py --config /usr/local/etc/abuseipdb_checker.conf >> /var/log/abuseipdb_checker.log 2>&1" >> ${abuseipdbchecker_cron}
    
    # Ensure log file exists and has proper permissions
    touch /var/log/abuseipdb_checker.log
    chmod 640 /var/log/abuseipdb_checker.log
    
    # Run initial check
    ${command} --config /usr/local/etc/abuseipdb_checker.conf >> /var/log/abuseipdb_checker.log 2>&1
    
    # Create PID file - this is important
    echo $$ > ${pidfile}
    echo "Started ${name} service (cron scheduled)"
}

abuseipdbchecker_stop()
{
    rm -f ${abuseipdbchecker_cron}
    rm -f ${pidfile}
    echo "Stopped ${name} service"
}

abuseipdbchecker_status()
{
    if [ -f "${pidfile}" ]; then
        echo "${name} is running"
    else
        echo "${name} is not running"
    fi
}

run_rc_command "$1"